<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fixed Authentication Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .test-section { background: #f8f9fa; padding: 15px; margin: 15px 0; border-radius: 5px; border-left: 4px solid #007bff; }
        .success { border-left-color: #28a745; }
        .error { border-left-color: #dc3545; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .result { background: #e9ecef; padding: 10px; margin: 10px 0; border-radius: 3px; font-family: monospace; white-space: pre-wrap; }
        .message { padding: 10px; margin: 10px 0; border-radius: 3px; }
        .message.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .message.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .message.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Fixed Authentication Test</h1>
        <p>This page tests the completely fixed authentication system.</p>
        
        <div id="message" class="message" style="display: none;"></div>
        
        <div class="test-section">
            <h3>1. Token Storage Verification</h3>
            <button onclick="checkTokenStorage()">Check Token Storage</button>
            <div id="token-result" class="result">Click to check token storage...</div>
        </div>
        
        <div class="test-section">
            <h3>2. Skills API Test (Should Work Without Token)</h3>
            <button onclick="testSkillsAPI()">Test Skills API</button>
            <div id="skills-result" class="result">Click to test skills endpoint...</div>
        </div>
        
        <div class="test-section">
            <h3>3. Exchange Request Test (Requires Token)</h3>
            <button onclick="testExchangeRequest()">Test Exchange Request</button>
            <div id="exchange-result" class="result">Click to test exchange request...</div>
        </div>
        
        <div class="test-section">
            <h3>4. Backend Connection Test</h3>
            <button onclick="testBackendConnection()">Test Backend Connection</button>
            <div id="backend-result" class="result">Click to test backend connection...</div>
        </div>
        
        <div class="test-section">
            <h3>5. Clear All Data</h3>
            <button onclick="clearAllData()">Clear All Tokens</button>
            <div id="clear-result" class="result">Click to clear all data...</div>
        </div>
        
        <div class="test-section">
            <h3>6. Manual Login Test</h3>
            <input type="text" id="test-username" placeholder="Username" value="testuser">
            <input type="password" id="test-password" placeholder="Password" value="password123">
            <button onclick="testLogin()">Test Login</button>
            <div id="login-result" class="result">Click to test login...</div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://127.0.0.1:8000';
        
        function showMessage(message, type) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = message;
            messageEl.className = `message ${type}`;
            messageEl.style.display = 'block';
            
            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 5000);
        }
        
        function updateResult(elementId, content, type = 'success') {
            const element = document.getElementById(elementId);
            element.textContent = content;
            element.className = `result ${type}`;
        }
        
        function checkTokenStorage() {
            console.log('üîç Checking token storage...');
            
            const access_token = localStorage.getItem('access_token');
            const authToken = localStorage.getItem('authToken');
            const token = localStorage.getItem('token');
            const currentUser = localStorage.getItem('currentUser');
            
            const result = `Token Storage Status:
access_token: ${access_token ? '‚úÖ Present (' + access_token.substring(0, 30) + '...)' : '‚ùå Missing'}
authToken: ${authToken ? '‚úÖ Present (' + authToken.substring(0, 30) + '...)' : '‚ùå Missing'}
token: ${token ? '‚úÖ Present (' + token.substring(0, 30) + '...)' : '‚ùå Missing'}
currentUser: ${currentUser ? '‚úÖ Present' : '‚ùå Missing'}

All localStorage keys: ${Object.keys(localStorage).join(', ')}

Available token: ${access_token || authToken || token ? '‚úÖ YES' : '‚ùå NO'}`;
            
            updateResult('token-result', result, access_token || authToken || token ? 'success' : 'error');
        }
        
        async function testSkillsAPI() {
            console.log('üîç Testing skills API...');
            updateResult('skills-result', 'Testing skills API...', 'warning');
            
            try {
                // Get token (optional for skills)
                const token = localStorage.getItem('access_token') || localStorage.getItem('authToken') || localStorage.getItem('token');
                console.log('üîç Token available for skills test:', !!token);
                
                const headers = {
                    'Content-Type': 'application/json',
                };
                
                // Only add auth header if token exists
                if (token) {
                    headers['Authorization'] = 'Bearer ' + token;
                }
                
                const response = await fetch(`${API_BASE_URL}/skills/`, {
                    method: 'GET',
                    headers: headers
                });
                
                console.log('üîç Skills response:', response.status);
                
                if (response.ok) {
                    const skills = await response.json();
                    const result = `‚úÖ Skills API Success!
Status: ${response.status}
Skills Count: ${skills.length}
Auth Header Used: ${token ? 'Yes' : 'No'}
${skills.length > 0 ? 'Sample Skill: ' + JSON.stringify(skills[0], null, 2).substring(0, 200) + '...' : 'No skills found'}`;
                    
                    updateResult('skills-result', result, 'success');
                    showMessage('Skills API working correctly!', 'success');
                } else {
                    const error = await response.text();
                    const result = `‚ùå Skills API Failed!
Status: ${response.status} ${response.statusText}
Error: ${error}
Auth Header Used: ${token ? 'Yes' : 'No'}`;
                    
                    updateResult('skills-result', result, 'error');
                    showMessage('Skills API failed!', 'error');
                }
            } catch (error) {
                const result = `‚ùå Skills API Network Error!
Error: ${error.message}
URL: ${API_BASE_URL}/skills/
This usually means backend is not running or CORS issue`;
                
                updateResult('skills-result', result, 'error');
                showMessage('Skills API network error!', 'error');
            }
        }
        
        async function testExchangeRequest() {
            console.log('üîç Testing exchange request...');
            updateResult('exchange-result', 'Testing exchange request...', 'warning');
            
            // Get token (required for exchange)
            const token = localStorage.getItem('access_token') || localStorage.getItem('authToken') || localStorage.getItem('token');
            
            if (!token) {
                const result = `‚ùå No Token Available!
Cannot test exchange request without authentication.
Please login first using the test login below.`;
                
                updateResult('exchange-result', result, 'error');
                showMessage('No token available for exchange request!', 'error');
                return;
            }
            
            try {
                const requestData = {
                    skill_id: 1,
                    message: 'Test exchange request from fixed auth test',
                };
                
                console.log('üîç Sending exchange request with token:', token.substring(0, 30) + '...');
                
                const response = await fetch(`${API_BASE_URL}/exchanges/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify(requestData),
                });
                
                console.log('üîç Exchange response:', response.status);
                
                if (response.ok) {
                    const result_data = await response.json();
                    const result = `‚úÖ Exchange Request Success!
Status: ${response.status}
Request ID: ${result_data.id || 'N/A'}
Token Used: ‚úÖ Yes
Response: ${JSON.stringify(result_data, null, 2).substring(0, 200) + '...'}`;
                    
                    updateResult('exchange-result', result, 'success');
                    showMessage('Exchange request working correctly!', 'success');
                } else {
                    const error = await response.json();
                    const result = `‚ùå Exchange Request Failed!
Status: ${response.status} ${response.statusText}
Error: ${error.detail || error}
Token Used: ‚úÖ Yes
This might be due to invalid skill_id or server error`;
                    
                    updateResult('exchange-result', result, 'error');
                    showMessage('Exchange request failed!', 'error');
                }
            } catch (error) {
                const result = `‚ùå Exchange Request Network Error!
Error: ${error.message}
URL: ${API_BASE_URL}/exchanges/
This usually means backend is not running or CORS issue`;
                
                updateResult('exchange-result', result, 'error');
                showMessage('Exchange request network error!', 'error');
            }
        }
        
        async function testBackendConnection() {
            console.log('üîç Testing backend connection...');
            updateResult('backend-result', 'Testing backend connection...', 'warning');
            
            try {
                const response = await fetch(`${API_BASE_URL}/`);
                
                if (response.ok) {
                    const data = await response.json();
                    const result = `‚úÖ Backend Connection Success!
Status: ${response.status}
Response: ${JSON.stringify(data)}
Backend is running correctly!`;
                    
                    updateResult('backend-result', result, 'success');
                    showMessage('Backend connection successful!', 'success');
                } else {
                    const result = `‚ùå Backend Connection Failed!
Status: ${response.status} ${response.statusText}
Backend might not be running properly`;
                    
                    updateResult('backend-result', result, 'error');
                    showMessage('Backend connection failed!', 'error');
                }
            } catch (error) {
                const result = `‚ùå Backend Connection Error!
Error: ${error.message}
URL: ${API_BASE_URL}/
Backend is not running or not accessible`;
                
                updateResult('backend-result', result, 'error');
                showMessage('Backend not accessible!', 'error');
            }
        }
        
        async function testLogin() {
            console.log('üîç Testing login...');
            updateResult('login-result', 'Testing login...', 'warning');
            
            const username = document.getElementById('test-username').value;
            const password = document.getElementById('test-password').value;
            
            if (!username || !password) {
                updateResult('login-result', 'Please enter username and password', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/users/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password }),
                });
                
                console.log('üîç Login response:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Save token with all keys (CRITICAL FIX)
                    localStorage.setItem('access_token', data.access_token);
                    localStorage.setItem('token', data.access_token);
                    localStorage.setItem('authToken', data.access_token);
                    
                    const result = `‚úÖ Login Success!
Username: ${username}
Token Type: ${data.token_type}
Token Length: ${data.access_token.length}
Token saved to localStorage with all keys:
- access_token ‚úÖ
- token ‚úÖ  
- authToken ‚úÖ

Token preview: ${data.access_token.substring(0, 50)}...`;
                    
                    updateResult('login-result', result, 'success');
                    showMessage('Login successful! Token saved correctly.', 'success');
                    
                    // Refresh token storage display
                    setTimeout(checkTokenStorage, 1000);
                } else {
                    const error = await response.json();
                    const result = `‚ùå Login Failed!
Status: ${response.status} ${response.statusText}
Error: ${error.detail || error}
Please check username/password or create account first`;
                    
                    updateResult('login-result', result, 'error');
                    showMessage('Login failed!', 'error');
                }
            } catch (error) {
                const result = `‚ùå Login Network Error!
Error: ${error.message}
URL: ${API_BASE_URL}/users/login
Backend might not be running`;
                
                updateResult('login-result', result, 'error');
                showMessage('Login network error!', 'error');
            }
        }
        
        function clearAllData() {
            console.log('üîç Clearing all data...');
            
            localStorage.removeItem('access_token');
            localStorage.removeItem('authToken');
            localStorage.removeItem('token');
            localStorage.removeItem('currentUser');
            
            updateResult('clear-result', '‚úÖ All tokens and user data cleared from localStorage', 'success');
            showMessage('All data cleared successfully!', 'info');
            
            // Refresh token storage display
            setTimeout(checkTokenStorage, 500);
        }
        
        // Auto-check on page load
        window.addEventListener('load', () => {
            console.log('üîç Fixed auth test page loaded');
            checkTokenStorage();
            testBackendConnection();
        });
    </script>
</body>
</html>
